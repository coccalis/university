
// ΑΣΦ06

#include <stdio.h>
#include <openssl/bn.h>
#define NBITS 256

void printBN(char *msg, BIGNUM * a)
{
/* Use BN_bn2hex(a) for hex string
* Use BN_bn2dec(a) for decimal string */
char * number_str = BN_bn2hex(a);
printf("%s %s\n", msg, number_str);
OPENSSL_free(number_str);
}

int main(){

	BN_CTX *ctx = BN_CTX_new();
	BIGNUM *n = BN_new();
	BIGNUM *p = BN_new();
	BIGNUM *q = BN_new();
	BIGNUM *d = BN_new();
	BIGNUM *e = BN_new();
	BIGNUM *k = BN_new();
	BIGNUM *l = BN_new();
	BIGNUM *res = BN_new();
	BIGNUM *j = BN_new();

	BN_hex2bn(&p, "953AAB9B3F23ED593FBDC690CA10E703");
	BN_hex2bn(&q, "C34EFC7C4C2369164E953553CDF94945");
	BN_hex2bn(&e, "0D88C3");
	BN_hex2bn(&j, "1");

	//Question 1

	BN_sub(k,p,j); // l=p-1
	BN_sub(l,q,j); // k=q-1
	BN_mul(n,p,q,ctx);//n=p*q
	BN_mul(res,k,l,ctx); //res=(p-1)(q-1)
	BN_mod_inverse(d,e,res,ctx); //inverse


	printBN("|Question 1| d= ",d);


	//Question 2
	BIGNUM *m = BN_new();
	BIGNUM *c = BN_new();

	BN_hex2bn(&m, "4368726973204b6f6b6b616c6973"); //Chris Kokkalis in hex.

	BN_mod_exp(c,m,e,n,ctx); // Encryption

	printBN("|Question 2| Encryption(C)= ", c);

	BN_mod_exp(m,c,d,n,ctx); //Decryption


	printBN("|Question 2| Decryption(M)= ", m);

	//Question 3

	BN_hex2bn(&n, "DCBFFE3E51F62E09CE7032E2677A78946A849DC4CDDE3A4D0CB81629242FB1A5");
	BN_hex2bn(&e, "010001");
	BN_hex2bn(&d, "74D806F9F3A62BAE331FFE3F0A68AFE35B3D2E4794148AACBC26AA381CD7D30D");
	BN_hex2bn(&c, "CAF7D72776AFEFBAC8269E1A8B76CE44A3B28015CA9A54E22C239EF38FCFAFFA");

	//We decrypt the message
	BN_mod_exp(m,c,d,n,ctx);
	printBN("|Question 3| Decryption(M)= ", m);


	//Question 4

	BIGNUM *sig = BN_new();
	BN_hex2bn(&m,"68656c6c6f20756e697761"); //message: hello uniwa
	BN_mod_exp(sig, m,d,n,ctx);
	printBN("|Question 4| Encrypt 1st message(hello uniwa): ", sig);

	BN_hex2bn(&m,"68656c6f20756e697761"); //message: helo uniwa
	BN_mod_exp(sig, m,d,n,ctx);
	printBN("|Question 4| Encrypt 2nd message(helo uniwa): ", sig);

	//Question 5A

	//M = Launch a missile.
	//S = 643D6F34902D9C7EC90CB0B2BCA36C47FA37165C0005CAB026C0542CBDB6802F
	//e = 010001 (this hex value equals to decimal 65537)
	//n = AE1CD4DC432798D933779FBD46C6E1247F0CF1233595113AA51B450F18116115

	BN_hex2bn(&sig, "643D6F34902D9C7EC90CB0B2BCA36C47FA37165C0005CAB026C0542CBDB6803F");
	//BN_hex2bn(&sig, "643D6F34902D9C7EC90CB0B2BCA36C47FA37165C0005CAB026C0542CBDB6802F");
	BN_hex2bn(&e,"010001");
	BN_hex2bn(&n,"AE1CD4DC432798D933779FBD46C6E1247F0CF1233595113AA51B450F18116115");
	BN_hex2bn(&m,"4c61756e63682061206d697373696c652e"); // Message: Launch a missile.

	BN_mod_exp(d,sig,e,n,ctx);

	printBN("\n|Question 5A| d= ", d);

	if(BN_cmp(d,m)){

	   printf("\nBob successfully sent the message to alice\n");

	}else{
	   printf("\nBod failed to sent the message to alice\n");
	}



	// Question 5B

	//M = Please transfer me $2000.Alice.
	//S = DB3F7CDB93483FC1E70E4EACA650E3C6505A3E5F49EA6EDF3E95E9A7C6C7A320
	//e = 010001 (this hex value equals to decimal 65537)
	//n = DCBFFE3E51F62E09CE7032E2677A78946A849DC4CDDE3A4D0CB81629242FB1A5

	BN_hex2bn(&sig, "DB3F7CDB93483FC1E70E4EACA650E3C6505A3E5F49EA6EDF3E95E9A7C6C7A320");
	BN_hex2bn(&e,"010001");
	BN_hex2bn(&n,"DCBFFE3E51F62E09CE7032E2677A78946A849DC4CDDE3A4D0CB81629242FB1A5");
	BN_hex2bn(&m,"506c65617365207472616e73666572206d652024323030302e416c6963652e"); // Message: Please transfer me $2000.Alice.

	BN_mod_exp(d,sig,e,n,ctx);

	printBN("\n|Question 5B| d= ", d);
	if(!BN_cmp(d,m)){

	   printf("\nAlice successfully sent the message to Bob\n");

	}else{
	   printf("\nAlice failed to sent the message to Bob\n");
	}


	//############## Question 6

	//n=F588DFE7628C1E37F83742907F6C87D0FB658225FDE8CB6BA4FF6DE95A23E299F61CE9920399137C090A8AFA42D65E5624AA7A33841FD1E969BBB974EC574C66689377375553FE39104DB734BB5F2577373B1794EA3CE59DD5BCC3B443EB2EA747EFB0441163D8B44185DD413048931BBFB7F6E0450221E0964217CFD92B6556340726040DA8FD7DCA2EEFEA487C374D3F009F83DFEF75842E79575CFC576E1A96FFFC8C9AA699BE25D97F962C06F7112A028080EB63183C504987E58ACA5F192B59968100A0FB51DBCA770B0BC9964FEF7049C75C6D20FD99B4B4E2CA2E77FD2DDC0BB66B130C8C192B179698B9F08BF6A027BBB6E38D518FBDAEC79BB1899D
	//e: 65537 (0x10001)
	//s: f06c4dc98f7fa488af481b27aa3276bea10a372a9622fe5e75550d38129dc429527a2514dd6ee35a64aab9d21def022ccf28f09e57a928d39509093b92090fb0c037b76ebce181dc26b2735e80c519b25b0f1e2643654143e4c7c4ab4f5de0519f2fcacefb7e6890b8afb2f36efdddd7d810a3a8d938d6631f184caed3567f50de8b81f3d1862861666b729be384813f3bca14153915dd91cb8b186d7b2d1b4b7cfd0cc34e952c929ba1e98e9c696995946a88317b9dde63ce91d5c4770a3e450aa3de16f3150c8f669cb024eb2c8f90245c6e9e95626d9d3abe151b25ec76a099f2de3bc7560ca800535f4d65efa6acaff0d5829f06c7dac90d0e7695c89994
	//m= 668f52cdc3fa1d1091f4fe7f0e9129cedc5466270c0b48bc2a99bbe33c12a84b

	BN_hex2bn(&n, "F588DFE7628C1E37F83742907F6C87D0FB658225FDE8CB6BA4FF6DE95A23E299F61CE9920399137C090A8AFA42D65E5624AA7A33841FD1E969BBB974EC574C66689377375553FE39104DB734BB5F2577373B1794EA3CE59DD5BCC3B443EB2EA747EFB0441163D8B44185DD413048931BBFB7F6E0450221E0964217CFD92B6556340726040DA8FD7DCA2EEFEA487C374D3F009F83DFEF75842E79575CFC576E1A96FFFC8C9AA699BE25D97F962C06F7112A028080EB63183C504987E58ACA5F192B59968100A0FB51DBCA770B0BC9964FEF7049C75C6D20FD99B4B4E2CA2E77FD2DDC0BB66B130C8C192B179698B9F08BF6A027BBB6E38D518FBDAEC79BB1899D");

	BN_hex2bn(&e, "10001");


	BN_hex2bn(&sig, "f06c4dc98f7fa488af481b27aa3276bea10a372a9622fe5e75550d38129dc429527a2514dd6ee35a64aab9d21def022ccf28f09e57a928d39509093b92090fb0c037b76ebce181dc26b2735e80c519b25b0f1e2643654143e4c7c4ab4f5de0519f2fcacefb7e6890b8afb2f36efdddd7d810a3a8d938d6631f184caed3567f50de8b81f3d1862861666b729be384813f3bca14153915dd91cb8b186d7b2d1b4b7cfd0cc34e952c929ba1e98e9c696995946a88317b9dde63ce91d5c4770a3e450aa3de16f3150c8f669cb024eb2c8f90245c6e9e95626d9d3abe151b25ec76a099f2de3bc7560ca800535f4d65efa6acaff0d5829f06c7dac90d0e7695c89994");

     	BN_hex2bn(&m, "668f52cdc3fa1d1091f4fe7f0e9129cedc5466270c0b48bc2a99bbe33c12a84b");


	BN_mod_exp(d, sig, e, n, ctx);

	printBN("\n|Question 6| d = \n", d);
	return 0;
}




